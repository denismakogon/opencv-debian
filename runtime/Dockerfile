ARG BUILD_IMAGE_DIGEST_TAG="ghcr.io/denismakogon/opencv-debian:4.5.5-build"

FROM ${BUILD_IMAGE_DIGEST_TAG} as build-stage

FROM debian:bullseye-slim

# ugly, but works
ENV runtime_deps="adwaita-icon-theme \
                  at-spi2-core \
                  autoconf \
                  automake \
                  autopoint \
                  binutils \
                  binutils-common \
                  binutils-x86-64-linux-gnu \
                  bsdextrautils \
                  ca-certificates \
                  dbus \
                  dbus-user-session \
                  dconf-gsettings-backend \
                  dconf-service \
                  debhelper \
                  dh-autoreconf \
                  dh-strip-nondeterminism \
                  dirmngr \
                  dmsetup \
                  dwz \
                  fakeroot \
                  file \
                  fontconfig \
                  fontconfig-config \
                  fonts-dejavu-core \
                  gettext \
                  gettext-base \
                  gir1.2-atk-1.0 \
                  gir1.2-atspi-2.0 \
                  gir1.2-freedesktop \
                  gir1.2-gdkpixbuf-2.0 \
                  gir1.2-glib-2.0 \
                  gir1.2-gtk-2.0 \
                  gir1.2-gtk-3.0 \
                  gir1.2-harfbuzz-0.0 \
                  gir1.2-pango-1.0 \
                  glib-networking \
                  glib-networking-common \
                  glib-networking-services \
                  gnupg \
                  gnupg-l10n \
                  gnupg-utils \
                  gpg \
                  gpg-agent \
                  gpg-wks-client \
                  gpg-wks-server \
                  gpgconf \
                  gpgsm \
                  groff-base \
                  gsettings-desktop-schemas \
                  gtk-update-icon-cache \
                  hicolor-icon-theme \
                  i965-va-driver \
                  icu-devtools \
                  intel-media-va-driver \
                  intltool-debian \
                  libaacs0 \
                  libalgorithm-diff-perl \
                  libalgorithm-diff-xs-perl \
                  libalgorithm-merge-perl \
                  libaom0 \
                  libapparmor1 \
                  libarchive-cpio-perl \
                  libarchive-zip-perl \
                  libargon2-1 \
                  libasan6 \
                  libassuan0 \
                  libatk-bridge2.0-0 \
                  libatk1.0-0 \
                  libatk1.0-data \
                  libatlas3-base \
                  libatomic1 \
                  libatspi2.0-0 \
                  libavahi-client3 \
                  libavahi-common-data \
                  libavahi-common3 \
                  libavcodec58 \
                  libavformat58 \
                  libavutil56 \
                  libbdplus0 \
                  libbinutils \
                  libbluray2 \
                  libbrotli1 \
                  libbsd0 \
                  libc-dev-bin \
                  libc-devtools \
                  libcairo-gobject2 \
                  libcairo-script-interpreter2 \
                  libcairo2 \
                  libcap2 \
                  libcc1-0 \
                  libchromaprint1 \
                  libcodec2-0.9 \
                  libcolord2 \
                  libcryptsetup12 \
                  libctf-nobfd0 \
                  libctf0 \
                  libcups2 \
                  libcurl4 \
                  libdatrie1 \
                  libdav1d4 \
                  libdbus-1-3 \
                  libdconf1 \
                  libdebhelper-perl \
                  libdeflate0 \
                  libdevmapper1.02.1 \
                  libdpkg-perl \
                  libdrm-amdgpu1 \
                  libdrm-common \
                  libdrm-intel1 \
                  libdrm-nouveau2 \
                  libdrm-radeon1 \
                  libdrm2 \
                  libedit2 \
                  libegl-mesa0 \
                  libegl1 \
                  libelf1 \
                  libepoxy0 \
                  libexif12 \
                  libexpat1 \
                  libfakeroot \
                  libfile-fcntllock-perl \
                  libfile-stripnondeterminism-perl \
                  libfontconfig1 \
                  libfreetype6 \
                  libfribidi0 \
                  libgail-common \
                  libgail18 \
                  libgbm1 \
                  libgd3 \
                  libgdbm-compat4 \
                  libgdbm6 \
                  libgdk-pixbuf-2.0-0 \
                  libgdk-pixbuf2.0-bin \
                  libgdk-pixbuf2.0-common \
                  libgfortran5 \
                  libgirepository-1.0-1 \
                  libgl1 \
                  libgl1-mesa-dri \
                  libglapi-mesa \
                  libgles1 \
                  libgles2 \
                  libglib2.0-0 \
                  libglib2.0-bin \
                  libglib2.0-data \
                  libglib2.0-dev-bin \
                  libglvnd0 \
                  libglx-mesa0 \
                  libglx0 \
                  libgme0 \
                  libgomp1 \
                  libgphoto2-6 \
                  libgphoto2-l10n \
                  libgphoto2-port12 \
                  libgpm2 \
                  libgraphite2-3 \
                  libgsm1 \
                  libgtk-3-0 \
                  libgtk-3-bin \
                  libgtk-3-common \
                  libgtk2.0-0 \
                  libgtk2.0-bin \
                  libgtk2.0-common \
                  libharfbuzz-gobject0 \
                  libharfbuzz-icu0 \
                  libharfbuzz0b \
                  libice6 \
                  libicu67 \
                  libigdgmm11 \
                  libip4tc2 \
                  libisl23 \
                  libitm1 \
                  libjbig0 \
                  libjpeg62-turbo \
                  libjson-c5 \
                  libjson-glib-1.0-0 \
                  libjson-glib-1.0-common \
                  libkmod2 \
                  libksba8 \
                  liblcms2-2 \
                  libldap-2.4-2 \
                  libldap-common \
                  libllvm11 \
                  liblocale-gettext-perl \
                  liblsan0 \
                  libltdl7 \
                  liblzo2-2 \
                  libmagic-mgc \
                  libmagic1 \
                  libmail-sendmail-perl \
                  libmd0 \
                  libmfx1 \
                  libmp3lame0 \
                  libmpc3 \
                  libmpdec3 \
                  libmpfr6 \
                  libmpg123-0 \
                  libncursesw6 \
                  libnghttp2-14 \
                  libnorm1 \
                  libnpth0 \
                  libnss-systemd \
                  libnuma1 \
                  libogg0 \
                  libopenblas0 \
                  libopenblas0-pthread \
                  libopengl0 \
                  libopenjp2-7 \
                  libopenmpt0 \
                  libopus0 \
                  libpam-systemd \
                  libpango-1.0-0 \
                  libpangocairo-1.0-0 \
                  libpangoft2-1.0-0 \
                  libpangoxft-1.0-0 \
                  libpciaccess0 \
                  libpcre16-3 \
                  libpcre2-16-0 \
                  libpcre2-32-0 \
                  libpcre2-posix2 \
                  libpcre32-3 \
                  libpcrecpp0v5 \
                  libperl5.32 \
                  libpgm-5.3-0 \
                  libpipeline1 \
                  libpixman-1-0 \
                  libpng-tools \
                  libpng16-16 \
                  libproxy1v5 \
                  libpsl5 \
                  libpython3-stdlib \
                  libpython3.9-minimal \
                  libpython3.9-stdlib \
                  libquadmath0 \
                  librabbitmq4 \
                  libraw1394-11 \
                  libreadline8 \
                  librest-0.7-0 \
                  librsvg2-2 \
                  librsvg2-common \
                  librtmp1 \
                  libsasl2-2 \
                  libsasl2-modules \
                  libsasl2-modules-db \
                  libsensors-config \
                  libsensors5 \
                  libshine3 \
                  libsigsegv2 \
                  libsm6 \
                  libsnappy1v5 \
                  libsodium23 \
                  libsoup-gnome2.4-1 \
                  libsoup2.4-1 \
                  libsoxr0 \
                  libspeex1 \
                  libsqlite3-0 \
                  libsrt1.4-gnutls \
                  libssh-gcrypt-4 \
                  libssh2-1 \
                  libsub-override-perl \
                  libswresample3 \
                  libswscale5 \
                  libsys-hostname-long-perl \
                  libthai-data \
                  libthai0 \
                  libtheora0 \
                  libtiff5 \
                  libtiffxx5 \
                  libtool \
                  libtsan0 \
                  libtwolame0 \
                  libubsan1 \
                  libuchardet0 \
                  libudfread0 \
                  libusb-1.0-0 \
                  libv4l-0 \
                  libv4l2rds0 \
                  libv4lconvert0 \
                  libva-drm2 \
                  libva-x11-2 \
                  libva2 \
                  libvdpau-va-gl1 \
                  libvdpau1 \
                  libvorbis0a \
                  libvorbisenc2 \
                  libvorbisfile3 \
                  libvpx6 \
                  libvulkan1 \
                  libwavpack1 \
                  libwayland-bin \
                  libwayland-client0 \
                  libwayland-cursor0 \
                  libwayland-egl1 \
                  libwayland-server0 \
                  libwebp6 \
                  libwebpdemux2 \
                  libwebpmux3 \
                  libx11-6 \
                  libx11-data \
                  libx11-xcb1 \
                  libx264-160 \
                  libx265-192 \
                  libxau6 \
                  libxcb-dri2-0 \
                  libxcb-dri3-0 \
                  libxcb-glx0 \
                  libxcb-present0 \
                  libxcb-randr0 \
                  libxcb-render0 \
                  libxcb-shm0 \
                  libxcb-sync1 \
                  libxcb-xfixes0 \
                  libxcb1 \
                  libxcomposite1 \
                  libxcursor1 \
                  libxdamage1 \
                  libxdmcp6 \
                  libxext6 \
                  libxfixes3 \
                  libxft2 \
                  libxi6 \
                  libxinerama1 \
                  libxkbcommon0 \
                  libxml2 \
                  libxml2-utils \
                  libxpm4 \
                  libxrandr2 \
                  libxrender1 \
                  libxshmfence1 \
                  libxtst6 \
                  libxvidcore4 \
                  libxxf86vm1 \
                  libz3-4 \
                  libzmq5 \
                  libzvbi-common \
                  libzvbi0 \
                  m4 \
                  media-types \
                  mesa-va-drivers \
                  mesa-vdpau-drivers \
                  mesa-vulkan-drivers \
                  netbase \
                  ocl-icd-libopencl1 \
                  openssl \
                  pango1.0-tools \
                  patch \
                  pinentry-curses \
                  po-debconf \
                  publicsuffix \
                  readline-common \
                  sensible-utils \
                  shared-mime-info \
                  systemd \
                  systemd-sysv \
                  systemd-timesyncd \
                  ucf \
                  va-driver-all \
                  vdpau-driver-all \
                  wayland-protocols \
                  x11-common \
                  xdg-user-dirs \
                  xkb-data \
                  xorg-sgml-doctools \
                  xz-utils \
                  perl \
                  perl-modules-5.32"

RUN apt-get update && \
    apt-get -y install --no-install-recommends ${runtime_deps} && \
    apt-get remove python3-doc python3-tk python3-venv python3.9-venv python3.9-doc -qy && \
    apt-get clean autoclean && \
    apt-get autoremove --yes && \
    rm -rf /var/lib/{apt,dpkg,cache,log}/

ENV PKG_CONFIG_PATH /usr/local/lib/pkgconfig
ENV LD_LIBRARY_PATH /usr/local/lib

COPY --from=build-stage /usr/local/lib /usr/local/lib
COPY --from=build-stage /usr/local/lib/pkgconfig/opencv4.pc /usr/local/lib/pkgconfig/opencv4.pc
COPY --from=build-stage /usr/local/include/opencv4 /usr/local/include/opencv4
